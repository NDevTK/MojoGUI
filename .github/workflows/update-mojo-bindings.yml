name: Update Mojo JS Bindings

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - '.github/workflows/update-mojo-bindings.yml'

permissions:
  contents: write

jobs:
  update-bindings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jinja2 ply

      - name: Create working directories
        run: |
          mkdir -p chromium_src
          mkdir -p bindings

      - name: Sparse checkout .mojom files from Chromium
        run: |
          cd chromium_src
          git init
          git remote add origin https://chromium.googlesource.com/chromium/src.git
          git config core.sparseCheckout true
          
          # Use universal pattern to get ALL .mojom files regardless of location
          # Also get mojo/public for base types and dependencies
          cat > .git/info/sparse-checkout << 'EOF'
          mojo/public/
          **/*.mojom
          EOF
          
          git pull --depth=1 origin main || git pull --depth=1 origin master

      - name: List .mojom files
        run: |
          # Finds all .mojom files in chromium_src
          # We sort them to help with stability, though dependencies matter more
          find chromium_src -name "*.mojom" | sort > mojom_files.txt
          
          echo "Found $(wc -l < mojom_files.txt) .mojom files"
          head -10 mojom_files.txt

      - name: Generate Mojo JS bindings
        run: |
          echo "Generating Mojo JS bindings using official generator..."
          
          # Set up paths
          export PYTHONPATH="$PYTHONPATH:$(pwd)/chromium_src"
          
          # Directory for bindings
          mkdir -p bindings
          
          # Create a Python script to drive the generation
          cat << 'SCRIPT' > generate_bindings.py
          import os
          import sys
          import json
          import subprocess
          import re
          from pathlib import Path
          
          # Configuration
          # We treat 'chromium_src' as the root of the source tree
          ROOT_DIR = 'chromium_src'
          
          def run_parser(mojom_path):
              """Run the mojom parser to generate -module file for a single input."""
              # We interpret the path relative to the checkout to keep things consistent
              # Input: chromium_src/foo/bar.mojom
              # We want parser to see: root=chromium_src, file=foo/bar.mojom
              
              cmd = [
                  sys.executable,
                  'chromium_src/mojo/public/tools/mojom/mojom_parser.py',
                  '--output-root', 'chromium_src',
                  '--input-root', 'chromium_src',
                  '--mojom-file-list', 'parser_input_list.txt'
              ]
              
              # Write temporary list file for this single input
              # We must pass the relative path so the parser finds it in input-root
              if mojom_path.startswith('chromium_src/') or mojom_path.startswith('chromium_src\\'):
                  rel_path = mojom_path[len('chromium_src/'):]
              else:
                  rel_path = mojom_path

              with open('parser_input_list.txt', 'w') as f:
                  f.write(rel_path + '\n')
              
              try:
                  # We capture output to avoid spamming logs with expected failures
                  subprocess.run(cmd, check=True, capture_output=True)
                  return True
              except subprocess.CalledProcessError as e:
                  # Enable debug printing only if needed or just count failures
                  # print(f"DEBUG: Parser failed for {mojom_path}: {e.stderr.decode()}")
                  return False

          def run_generator(mojom_path):
              """Run the bindings generator for a single input."""
              # Input: chromium_src/foo/bar.mojom
              # We use --depth chromium_src so the generator treats inputs as relative to that
              
              cmd = [
                  sys.executable,
                  'chromium_src/mojo/public/tools/bindings/mojom_bindings_generator.py',
                  '--use_bundled_pylibs',
                  'generate',
                  '-g', 'javascript',
                  '--output_dir', 'chromium_src', 
                  '--depth', 'chromium_src', 
                  '--bytecode_path', 'bindings', 
                  mojom_path
              ]
              try:
                  subprocess.run(cmd, check=True, capture_output=True)
                  return True
              except subprocess.CalledProcessError:
                  return False

          def parse_mojom_file(file_path):
               # Simplified regex checks for interface names
               try:
                   with open(file_path, 'r', encoding='utf-8') as f:
                       content = f.read()
                   module_match = re.search(r'module\s+([\w.]+);', content)
                   module = module_match.group(1) if module_match else 'unknown'
                   interfaces = []
                   for match in re.finditer(r'interface\s+(\w+)', content):
                       interfaces.append({'name': match.group(1)})
                   return {'module': module, 'interfaces': interfaces}
               except:
                   return None

          def main():
              bindings_dir = Path('bindings')
              
              # Read file list
              with open('mojom_files.txt', 'r') as f:
                  files = [line.strip() for line in f if line.strip()]
              
              print(f"Processing {len(files)} files...")
              
              successful_count = 0
              
              for mojom_path in files:
                  # Skip non-files or weird entries
                  if not os.path.isfile(mojom_path):
                      continue

                  # 1. Parse
                  if not run_parser(mojom_path):
                      # print(f"Skipping {mojom_path} (Parse failed)")
                      continue
                      
                  # 2. Generate
                  if run_generator(mojom_path):
                      successful_count += 1
                      # Move generated -lite.js file to bindings/
                      # Expected path: chromium_src/path/to/foo.mojom-lite.js
                      src_p = Path(mojom_path)
                      gen_lite = src_p.with_suffix('.mojom-lite.js')
                      
                      if gen_lite.exists():
                          # Flatten name: third_party_blink_..._foo.mojom.js
                          rel_parts = src_p.parts[1:] # Drop chromium_src
                          flat_name = '_'.join(rel_parts).replace('.mojom', '.mojom.js')
                          dest = bindings_dir / flat_name
                          
                          import shutil
                          shutil.move(str(gen_lite), str(dest))
                          # print(f"Generated: {flat_name}")

              print(f"Successfully generated bindings for {successful_count} files.")

          if __name__ == '__main__':
              main()
          SCRIPT
          
          # Run the script
          python generate_bindings.py
          
      - name: Generate index.js
        run: |
          cat > bindings/index.js << 'EOF'
          // MojoJS Bindings Index
          // Auto-generated - Do not edit manually

          (function(global) {
            'use strict';

            // Create trusted types policy for script URLs
            let trustedPolicy = null;
            if (typeof window.trustedTypes !== 'undefined') {
              try {
                trustedPolicy = window.trustedTypes.createPolicy('mojoBindings', {
                  createScriptURL: (input) => input
                });
              } catch (e) {
                console.warn('Could not create trusted types policy:', e);
              }
            }

            const MojoBindings = {
              _indexData: null,
              _loadedModules: {},

              async loadIndex() {
                if (this._indexData) return this._indexData;
                const response = await fetch('./bindings/index.json');
                this._indexData = await response.json();
                return this._indexData;
              },

              async getInterfaces() {
                const data = await this.loadIndex();
                return data.interfaces;
              },

              async searchInterfaces(query) {
                const interfaces = await this.getInterfaces();
                const q = query.toLowerCase();
                return interfaces.filter(i => 
                  i.name.toLowerCase().includes(q) || 
                  i.module.toLowerCase().includes(q)
                );
              },

              async loadBinding(filename) {
                if (this._loadedModules[filename]) {
                  return this._loadedModules[filename];
                }
                return new Promise((resolve, reject) => {
                  const script = document.createElement('script');
                  const scriptUrl = `./bindings/${filename}`;
                  
                  if (trustedPolicy) {
                    script.src = trustedPolicy.createScriptURL(scriptUrl);
                  } else {
                    script.src = scriptUrl;
                  }
                  
                  script.onload = () => {
                    this._loadedModules[filename] = true;
                    resolve(true);
                  };
                  script.onerror = () => {
                    reject(new Error(`Failed to load binding: ${filename}`));
                  };
                  document.head.appendChild(script);
                });
              },

              getMetadata() {
                return this._indexData;
              }
            };

            global.MojoBindings = MojoBindings;
          })(typeof window !== 'undefined' ? window : this);
          EOF

      - name: Build Mojo JS core bindings
        run: |
          echo "Building Mojo JS core bindings..."
          # Concatenate files in order defined by BUILD.gn
          cat chromium_src/mojo/public/js/base.js \
              chromium_src/mojo/public/js/bindings.js \
              chromium_src/mojo/public/js/interface_types.js \
              chromium_src/mojo/public/js/lib/buffer.js \
              chromium_src/mojo/public/js/lib/codec.js \
              chromium_src/mojo/public/js/lib/connector.js \
              chromium_src/mojo/public/js/lib/control_message_handler.js \
              chromium_src/mojo/public/js/lib/control_message_proxy.js \
              chromium_src/mojo/public/js/lib/interface_endpoint_client.js \
              chromium_src/mojo/public/js/lib/interface_endpoint_handle.js \
              chromium_src/mojo/public/js/lib/pipe_control_message_handler.js \
              chromium_src/mojo/public/js/lib/pipe_control_message_proxy.js \
              chromium_src/mojo/public/js/lib/router.js \
              chromium_src/mojo/public/js/lib/unicode.js \
              chromium_src/mojo/public/js/lib/validator.js \
              > bindings/mojo_bindings.js
          
          # Append generated system mojoms if they exist (using wildcard to avoid failure if missing)
          # These are usually in bindings/ folder after generation
          if ls bindings/*interface_control_messages.mojom.js 1> /dev/null 2>&1; then
             cat bindings/*interface_control_messages.mojom.js >> bindings/mojo_bindings.js
          fi
          if ls bindings/*pipe_control_messages.mojom.js 1> /dev/null 2>&1; then
             cat bindings/*pipe_control_messages.mojom.js >> bindings/mojo_bindings.js
          fi

          echo "Core bindings built."
          ls -la bindings/mojo_bindings.js

      - name: Cleanup temporary files
        run: |
          # Remove all temporary files that should NOT be committed
          rm -rf chromium_src/
          rm -f mojom_files.txt
          echo "Cleaned up temporary files"

      - name: Commit only generated binding files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Explicitly add ONLY the generated binding files
          git add bindings/*.mojom.js
          git add bindings/index.js
          git add bindings/index.json
          # Add the copied core bindings
          git add bindings/mojo_bindings.js
          git add bindings/*.js
          
          # Show what will be committed
          echo "Files staged for commit:"
          git diff --staged --name-only
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            CHANGED_COUNT=$(git diff --staged --name-only | wc -l)
            git commit -m "Update Mojo JS bindings - $(date -u +%Y-%m-%d) [$CHANGED_COUNT files]"
            git push
          fi
