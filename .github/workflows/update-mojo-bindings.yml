name: Update Mojo JS Bindings

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - '.github/workflows/update-mojo-bindings.yml'

permissions:
  contents: write

jobs:
  update-bindings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jinja2 ply

      - name: Create working directories
        run: |
          mkdir -p chromium_src
          mkdir -p bindings

      - name: Sparse checkout .mojom files from Chromium
        run: |
          cd chromium_src
          git init
          git remote add origin https://chromium.googlesource.com/chromium/src.git
          git config core.sparseCheckout true
          
          # Use universal pattern to get ALL .mojom files regardless of location
          # Also get mojo/public for base types and dependencies
          cat > .git/info/sparse-checkout << 'EOF'
          mojo/public/
          **/*.mojom
          EOF
          
          git pull --depth=1 origin main || git pull --depth=1 origin master

      - name: Find and list .mojom files
        run: |
          find chromium_src -name "*.mojom" -type f > mojom_files.txt
          echo "Found $(wc -l < mojom_files.txt) .mojom files"
          head -20 mojom_files.txt

          # Rename bindings.js to mojo_bindings.js as that is what is often expected, 
          # but keep original if needed by other files?
          # Actually, let's just copy it to mojo_bindings.js so we have the standard name
          cp chromium_src/mojo/public/js/bindings.js bindings/mojo_bindings.js
          
          echo "Core bindings copied."
          ls -la bindings/

      - name: Generate Mojo JS bindings
        run: |
          echo "Generating Mojo JS bindings using official generator..."
          
          # Set up paths
          export PYTHONPATH="$PYTHONPATH:$(pwd)/chromium_src"
          
          # Directory for bindings
          mkdir -p bindings
          
          # Create a Python script to drive the generation and indexing
          cat << 'SCRIPT' > generate_bindings.py
          import os
          import sys
          import json
          import subprocess
          import re
          from pathlib import Path
          
          def parse_mojom_file(file_path):
              """Basic regex-based parsing of mojom files to extract interface names and methods."""
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  module_match = re.search(r'module\s+([\w.]+);', content)
                  module = module_match.group(1) if module_match else 'unknown'
                  
                  interfaces = []
                  # Regex to find interfaces
                  # This is simplified and might miss some complex cases
                  interface_blocks = re.finditer(r'interface\s+(\w+)\s*{(.*?)}', content, re.DOTALL)
                  
                  for match in interface_blocks:
                      interface_name = match.group(1)
                      body = match.group(2)
                      
                      methods = []
                      # Find methods: name(args) => ...
                      # Very basic regex, assumes standard formatting
                      method_matches = re.finditer(r'(\w+)\s*\(', body)
                      for m in method_matches:
                          methods.append({'name': m.group(1)})
                          
                      interfaces.append({
                          'name': interface_name,
                          'methods': methods
                      })
                      
                  return {
                      'module': module,
                      'interfaces': interfaces
                  }
              except Exception as e:
                  print(f"Error parsing {file_path}: {e}")
                  return None

          def run_generator(mojom_path):
              """Run the official mojom bindings generator."""
              cmd = [
                  sys.executable,
                  'chromium_src/mojo/public/tools/bindings/mojom_bindings_generator.py',
                  '--use_bundled_pylibs',
                  'generate',
                  '-g', 'javascript',
                  '--output_dir', '.',  # Output relative to current dir, mapping source struct
                  '--depth', '.',       # Root for relative paths
                  '--bytecode_path', 'bindings', # Required for caching/intermediate files
                  mojom_path
              ]
              try:
                  subprocess.run(cmd, check=True, capture_output=True)
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"Failed to generate for {mojom_path}: {e.stderr.decode()}")
                  return False

          # Main execution
          bindings_dir = Path('bindings')
          bindings_dir.mkdir(exist_ok=True)
          
          index_data = {
              'generated_at': '',
              'interfaces': [],
              'files': []
          }
          
          import datetime
          index_data['generated_at'] = datetime.datetime.utcnow().isoformat() + 'Z'
          
          # Read mojom files list
          with open('mojom_files.txt', 'r') as f:
              mojom_files = [line.strip() for line in f if line.strip()]
          
          print(f"Processing {len(mojom_files)} .mojom files...")
          
          for mojom_path in mojom_files:
              # Run official generator
              if run_generator(mojom_path):
                  # Move generated files to bindings/ directory to flatten structure
                  # The generator outputs to {root}/{path/to/file}.js
                  # We want to move them to bindings/ and flatten them potentially, 
                  # OR keep structure but we need to know where they are.
                  # Let's see: if input is chromium_src/foo/bar.mojom
                  # output is chromium_src/foo/bar.mojom.js under --output_dir .
                  
                  # We want to move these to bindings/ directory
                  # Construct expected output path
                  src_path = Path(mojom_path)
                  gen_base = src_path.with_suffix('.mojom.js') # Standard bindings
                  gen_lite = src_path.with_suffix('.mojom-lite.js') # Lite bindings (what we want)
                  
                  if gen_lite.exists():
                      # Flattened name for bindings dir: third_party_blink_public_mojom_foo.mojom.js
                      # This avoids collisions and directory depth issues in the simple server
                      rel_path = str(src_path).replace('chromium_src/', '').replace('chromium_src\\', '')
                      flat_name = rel_path.replace('/', '_').replace('\\', '_').replace('.mojom', '.mojom.js')
                      
                      dest_lite = bindings_dir / flat_name
                      
                      # Copy/Move the lite binding to destination as the main file we use
                      import shutil
                      shutil.move(str(gen_lite), str(dest_lite))
                      
                      # Also move the HTML-formatted binding if it exists (useful for reading)
                      # shutil.move(str(gen_base), str(bindings_dir / (flat_name + '.full.js')))
                      
                      parsed = parse_mojom_file(mojom_path)
                      if parsed and parsed.get('interfaces'):
                          # Add to index
                          for interface in parsed['interfaces']:
                              index_data['interfaces'].append({
                                  'name': interface['name'],
                                  'module': parsed['module'],
                                  'file': flat_name, # Point to the lite binding
                                  'methods': [m['name'] for m in interface.get('methods', [])]
                              })
                          
                          index_data['files'].append({
                              'filename': flat_name,
                              'source': rel_path,
                              'module': parsed['module']
                          })
                          print(f"Index updated for: {flat_name}")
                  else:
                      print(f"Warning: Expected generated file not found: {gen_lite}")

          # Write index.json
          with open(bindings_dir / 'index.json', 'w') as f:
              json.dump(index_data, f, indent=2)
          
          print(f"\nIndexed {len(index_data['files'])} binding files")
          print(f"Total interfaces: {len(index_data['interfaces'])}")
          
          SCRIPT
          
          # Run the script
          python generate_bindings.py
          
      - name: Generate index.js
        run: |
          cat > bindings/index.js << 'EOF'
          // MojoJS Bindings Index
          // Auto-generated - Do not edit manually

          (function(global) {
            'use strict';

            // Create trusted types policy for script URLs
            let trustedPolicy = null;
            if (typeof window.trustedTypes !== 'undefined') {
              try {
                trustedPolicy = window.trustedTypes.createPolicy('mojoBindings', {
                  createScriptURL: (input) => input
                });
              } catch (e) {
                console.warn('Could not create trusted types policy:', e);
              }
            }

            const MojoBindings = {
              _indexData: null,
              _loadedModules: {},

              async loadIndex() {
                if (this._indexData) return this._indexData;
                const response = await fetch('./bindings/index.json');
                this._indexData = await response.json();
                return this._indexData;
              },

              async getInterfaces() {
                const data = await this.loadIndex();
                return data.interfaces;
              },

              async searchInterfaces(query) {
                const interfaces = await this.getInterfaces();
                const q = query.toLowerCase();
                return interfaces.filter(i => 
                  i.name.toLowerCase().includes(q) || 
                  i.module.toLowerCase().includes(q)
                );
              },

              async loadBinding(filename) {
                if (this._loadedModules[filename]) {
                  return this._loadedModules[filename];
                }
                return new Promise((resolve, reject) => {
                  const script = document.createElement('script');
                  const scriptUrl = `./bindings/${filename}`;
                  
                  if (trustedPolicy) {
                    script.src = trustedPolicy.createScriptURL(scriptUrl);
                  } else {
                    script.src = scriptUrl;
                  }
                  
                  script.onload = () => {
                    this._loadedModules[filename] = true;
                    resolve(true);
                  };
                  script.onerror = () => {
                    reject(new Error(`Failed to load binding: ${filename}`));
                  };
                  document.head.appendChild(script);
                });
              },

              getMetadata() {
                return this._indexData;
              }
            };

            global.MojoBindings = MojoBindings;
          })(typeof window !== 'undefined' ? window : this);
          EOF

      - name: Build Mojo JS core bindings
        run: |
          echo "Building Mojo JS core bindings..."
          # Concatenate files in order defined by BUILD.gn
          cat chromium_src/mojo/public/js/base.js \
              chromium_src/mojo/public/js/bindings.js \
              chromium_src/mojo/public/js/interface_types.js \
              chromium_src/mojo/public/js/lib/buffer.js \
              chromium_src/mojo/public/js/lib/codec.js \
              chromium_src/mojo/public/js/lib/connector.js \
              chromium_src/mojo/public/js/lib/control_message_handler.js \
              chromium_src/mojo/public/js/lib/control_message_proxy.js \
              chromium_src/mojo/public/js/lib/interface_endpoint_client.js \
              chromium_src/mojo/public/js/lib/interface_endpoint_handle.js \
              chromium_src/mojo/public/js/lib/pipe_control_message_handler.js \
              chromium_src/mojo/public/js/lib/pipe_control_message_proxy.js \
              chromium_src/mojo/public/js/lib/router.js \
              chromium_src/mojo/public/js/lib/unicode.js \
              chromium_src/mojo/public/js/lib/validator.js \
              > bindings/mojo_bindings.js
          
          # Append generated system mojoms if they exist (using wildcard to avoid failure if missing)
          # These are usually in bindings/ folder after generation
          if ls bindings/*interface_control_messages.mojom.js 1> /dev/null 2>&1; then
             cat bindings/*interface_control_messages.mojom.js >> bindings/mojo_bindings.js
          fi
          if ls bindings/*pipe_control_messages.mojom.js 1> /dev/null 2>&1; then
             cat bindings/*pipe_control_messages.mojom.js >> bindings/mojo_bindings.js
          fi

          echo "Core bindings built."
          ls -la bindings/mojo_bindings.js

      - name: Cleanup temporary files
        run: |
          # Remove all temporary files that should NOT be committed
          rm -rf chromium_src/
          rm -f mojom_files.txt
          echo "Cleaned up temporary files"

      - name: Commit only generated binding files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Explicitly add ONLY the generated binding files
          git add bindings/*.mojom.js
          git add bindings/index.js
          git add bindings/index.json
          # Add the copied core bindings
          git add bindings/mojo_bindings.js
          git add bindings/*.js
          
          # Show what will be committed
          echo "Files staged for commit:"
          git diff --staged --name-only
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            CHANGED_COUNT=$(git diff --staged --name-only | wc -l)
            git commit -m "Update Mojo JS bindings - $(date -u +%Y-%m-%d) [$CHANGED_COUNT files]"
            git push
          fi
